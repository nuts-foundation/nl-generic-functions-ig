{
  "openapi": "3.0.3",
  "info": {
    "title": "NUTS Care Services Proxy Authorization API",
    "description": "API specification for the NUTS Care Services proxy FHIR query rewriting with search narrowing based on authorization policies.\n\nThis API is part of a two-phase authorization approach:\n1. **Phase 1 - Token Introspection:** Use the NUTS `/internal/auth/v2/accesstoken/introspect_extended` endpoint to obtain Verifiable Presentations. See the NUTS API specification: https://nuts-node.readthedocs.io/en/v1/_static/auth/v2.yaml\n2. **Phase 2 - Search Narrowing:** Use the `/authorization/search-narrowing` endpoint (defined in this spec) to rewrite FHIR queries based on authorization policies\n\nThe introspection result from Phase 1 is passed to the search-narrowing endpoint in Phase 2.",
    "version": "2.0.0"
  },
  "servers": [
    {
      "url": "https://nuts.example.com",
      "description": "NUTS node server"
    }
  ],
  "paths": {
    "/authorization/search-narrowing": {
      "post": {
        "summary": "FHIR Query Rewriting with Search Narrowing (Phase 2)",
        "description": "This endpoint is invoked after token introspection to obtain a rewritten FHIR query\nthat applies search-narrowing based on authorization policies.\n\nThe proxy provides:\n- The introspection result from Phase 1\n- The HTTP request details (method, path, query parameters, headers)\n- Client certificate properties (if applicable for mTLS)\n\nThe Policy Decision Point (PDP) returns:\n- A rewritten FHIR query with search-narrowing parameters\n- Authorization decision (allow/deny)\n- Applied filters for auditability\n",
        "operationId": "searchNarrowing",
        "tags": [
          "Phase 2 - Authorization"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/SearchNarrowingRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Successfully returned rewritten query",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SearchNarrowingResponse"
                }
              }
            }
          },
          "400": {
            "description": "Bad request",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Access denied",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "SearchNarrowingRequest": {
        "type": "object",
        "required": [
          "introspection_result",
          "http_request"
        ],
        "properties": {
          "introspection_result": {
            "type": "object",
            "description": "The token introspection result from the NUTS `/internal/auth/v2/accesstoken/introspect_extended` endpoint. See the NUTS API specification for the complete schema: https://nuts-node.readthedocs.io/en/v1/_static/auth/v2.yaml\n\nThis object contains standard OAuth 2.0 introspection fields (RFC 7662) plus:\n- `vps`: Array of Verifiable Presentations with Verifiable Credentials\n- `presentation_definitions`: Presentation Definitions that were requested\n- `presentation_submissions`: Presentation Submissions showing how VPs fulfill definitions\n\nAdditional properties are extracted from the Verifiable Credentials (e.g., user_type, user_id, organization_identifier, name).",
            "additionalProperties": true,
            "example": {
              "active": true,
              "iss": "https://example.com/oauth2/authorizer",
              "client_id": "https://requester.example.com",
              "exp": 1735689599,
              "iat": 1735603199,
              "scope": "patient/*.read",
              "vps": [
                {
                  "type": ["VerifiablePresentation"],
                  "verifiableCredential": [
                    {
                      "type": ["VerifiableCredential", "DeziLoginCredential"],
                      "credentialSubject": {
                        "type": "Practitioner",
                        "identifier": "urn:oid:2.16.528.1.1007.3.1:123456789"
                      }
                    }
                  ]
                }
              ]
            }
          },
          "http_request": {
            "type": "object",
            "required": [
              "method",
              "path"
            ],
            "properties": {
              "method": {
                "type": "string",
                "description": "HTTP method",
                "enum": [
                  "GET",
                  "POST",
                  "PUT",
                  "DELETE",
                  "PATCH"
                ],
                "example": "GET"
              },
              "path": {
                "type": "string",
                "description": "Request path (without query parameters)",
                "example": "/Patient"
              },
              "query_params": {
                "type": "object",
                "description": "Query parameters as key-value pairs",
                "additionalProperties": {
                  "oneOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  ]
                },
                "example": {
                  "name": "Smith",
                  "_count": "10"
                }
              },
              "headers": {
                "type": "object",
                "description": "Relevant HTTP headers",
                "additionalProperties": {
                  "type": "string"
                },
                "example": {
                  "Content-Type": "application/fhir+json",
                  "Accept": "application/fhir+json"
                }
              }
            }
          },
          "client_certificate": {
            "type": "object",
            "description": "Properties extracted from client certificate (if mTLS is used)",
            "properties": {
              "subject_dn": {
                "type": "string",
                "description": "Subject Distinguished Name",
                "example": "CN=Organization Name,O=Organization,C=NL"
              },
              "issuer_dn": {
                "type": "string",
                "description": "Issuer Distinguished Name",
                "example": "CN=PKIoverheid,O=Staat der Nederlanden,C=NL"
              },
              "serial_number": {
                "type": "string",
                "description": "Certificate serial number",
                "example": "123456789"
              },
              "not_before": {
                "type": "string",
                "format": "date-time",
                "description": "Certificate validity start date"
              },
              "not_after": {
                "type": "string",
                "format": "date-time",
                "description": "Certificate validity end date"
              },
              "san": {
                "type": "array",
                "description": "Subject Alternative Names",
                "items": {
                  "type": "string"
                },
                "example": [
                  "urn:oid:2.16.840.1.113883.2.4.6.1:12345678"
                ]
              }
            }
          },
          "use_case": {
            "type": "string",
            "description": "The use case context for authorization",
            "enum": [
              "mCSD",
              "patient_access",
              "care_services",
              "administration_directory"
            ],
            "example": "patient_access"
          }
        }
      },
      "SearchNarrowingResponse": {
        "type": "object",
        "required": [
          "allowed"
        ],
        "properties": {
          "allowed": {
            "type": "boolean",
            "description": "Whether the request is allowed",
            "example": true
          },
          "rewritten_query": {
            "type": "string",
            "description": "The complete rewritten query path with search-narrowing parameters. Use business-appropriate search parameters such as type, identifier, status, or custom SearchParameters on extensions (e.g., mcsd-profile=admin).",
            "example": "/Patient?_has:CareTeam:patient:participant:Practitioner.identifier=urn:oid:2.16.528.1.1007.3.1:123456789"
          },
          "original_query": {
            "type": "string",
            "description": "The original requested query for reference",
            "example": "/Patient"
          },
          "applied_filters": {
            "type": "array",
            "description": "List of filters applied to narrow the scope",
            "items": {
              "type": "object",
              "properties": {
                "parameter": {
                  "type": "string",
                  "description": "FHIR search parameter name",
                  "example": "_has:CareTeam:patient:participant:Practitioner.identifier"
                },
                "value": {
                  "type": "string",
                  "description": "Parameter value",
                  "example": "urn:oid:2.16.528.1.1007.3.1:123456789"
                },
                "reason": {
                  "type": "string",
                  "description": "Explanation for why this filter was applied",
                  "example": "Practitioner can only access patients where they are a CareTeam participant"
                }
              }
            }
          },
          "allowed_operations": {
            "type": "array",
            "description": "List of HTTP methods allowed for this resource",
            "items": {
              "type": "string",
              "enum": [
                "GET",
                "POST",
                "PUT",
                "DELETE",
                "PATCH"
              ]
            },
            "example": [
              "GET",
              "POST"
            ]
          },
          "resource_constraints": {
            "type": "object",
            "description": "Additional constraints on the resource access",
            "properties": {
              "required_extensions": {
                "type": "array",
                "description": "Extensions that must be present on resources. Use custom SearchParameters to make extensions searchable.",
                "items": {
                  "type": "string"
                },
                "example": [
                  "http://nuts.nl/fhir/StructureDefinition/mcsd-profile"
                ]
              },
              "required_codes": {
                "type": "object",
                "description": "Required code values for specific fields",
                "additionalProperties": {
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "example": {
                  "type": ["prov"],
                  "active": ["true"],
                  "mcsd-profile": ["admin"]
                }
              },
              "search_parameters": {
                "type": "array",
                "description": "Custom SearchParameters required for filtering (e.g., for extension-based searches)",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string",
                      "example": "mcsd-profile"
                    },
                    "url": {
                      "type": "string",
                      "example": "http://nuts.nl/fhir/SearchParameter/Organization-mcsd-profile"
                    },
                    "description": {
                      "type": "string",
                      "example": "Searches on the mcsd-profile extension"
                    }
                  }
                }
              },
              "denied_elements": {
                "type": "array",
                "description": "FHIR elements that should be filtered out",
                "items": {
                  "type": "string"
                },
                "example": [
                  "Patient.identifier"
                ]
              }
            }
          },
          "audit_info": {
            "type": "object",
            "description": "Information for audit logging",
            "properties": {
              "policy_decision_id": {
                "type": "string",
                "description": "Unique identifier for this authorization decision",
                "example": "pdp-12345-67890"
              },
              "applied_policies": {
                "type": "array",
                "description": "List of policy rules that were evaluated",
                "items": {
                  "type": "string"
                },
                "example": [
                  "related-person-patient-access-v1",
                  "search-narrowing-related-person-v1"
                ]
              }
            }
          }
        }
      },
      "Error": {
        "type": "object",
        "required": [
          "error",
          "message"
        ],
        "properties": {
          "error": {
            "type": "string",
            "description": "Error code",
            "example": "unauthorized"
          },
          "message": {
            "type": "string",
            "description": "Human-readable error message",
            "example": "The requester is not authorized to access this resource"
          },
          "details": {
            "type": "object",
            "description": "Additional error details",
            "additionalProperties": true
          }
        }
      }
    },
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "OAuth 2.0 Bearer token for client authentication"
      }
    }
  },
  "security": [
    {
      "bearerAuth": []
    }
  ]
}
